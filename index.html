<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Lebenszeit Tracker</title>
    <style>
      :root {
        --primary: #3498db;
        --secondary: #2ecc71;
        --warning: #f1c40f;
        --danger: #e74c3c;
        --bg: #f4f7f6;
      }
      body {
        font-family: -apple-system, system-ui, sans-serif;
        background: var(--bg);
        padding: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0;
        min-height: 100vh;
      }
      .card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        width: 100%;
        max-width: 400px;
        margin-bottom: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        box-sizing: border-box;
      }
      input {
        width: 100%;
        padding: 12px;
        margin-bottom: 10px;
        border: 2px solid #eee;
        border-radius: 8px;
        font-size: 1rem;
        box-sizing: border-box;
      }
      .timer {
        font-size: 3rem;
        text-align: center;
        margin: 10px 0;
        font-family: monospace;
        font-weight: bold;
        color: var(--primary);
      }
      .btn-group {
        display: flex;
        gap: 10px;
      }
      button {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        font-size: 1rem;
      }
      .btn-start {
        background: var(--secondary);
      }
      .btn-pause {
        background: var(--warning);
      }
      .btn-stop {
        background: var(--danger);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .stat-item {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        border: 1px solid #eee;
        display: flex;
        flex-direction: column;
      }
      .stat-label {
        font-size: 0.7rem;
        color: #7f8c8d;
        display: block;
        text-transform: uppercase;
        margin-bottom: 4px;
      }
      .stat-val {
        font-weight: bold;
        font-size: 1.1rem;
        color: #2c3e50;
      }

      .year-select {
        border: none;
        background: #ececec;
        font-size: 0.65rem;
        color: #555;
        border-radius: 4px;
        padding: 2px 4px;
        cursor: pointer;
        font-weight: bold;
      }

      #manualForm {
        display: none;
        background: #fdfdfd;
        border: 1px solid #eee;
        border-radius: 10px;
        padding: 15px;
        margin-top: 15px;
        position: relative;
      }
      .manual-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .manual-header span {
        font-size: 0.85rem;
        font-weight: bold;
        color: #7f8c8d;
      }
      .btn-close-x {
        background: none;
        border: none;
        color: #bdc3c7;
        font-size: 1.5rem;
        cursor: pointer;
        line-height: 1;
        padding: 0;
        width: auto;
      }
      .btn-save-manual {
        background: var(--primary);
        width: 100%;
        margin-top: 5px;
      }

      .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .btn-add-manual {
        background: var(--primary);
        color: white;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
        border: none;
      }
      .history-list {
        max-height: 250px;
        overflow-y: auto;
      }
      .history-item {
        padding: 10px;
        border-bottom: 1px solid #f1f1f1;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .task-info {
        display: flex;
        flex-direction: column;
      }
      .task-title {
        font-weight: bold;
        font-size: 0.9rem;
      }
      .task-date {
        font-size: 0.7rem;
        color: #bdc3c7;
      }
      .task-dur {
        font-weight: bold;
        color: var(--primary);
      }

      footer {
        margin-top: auto;
        padding: 20px;
        text-align: center;
        font-size: 0.75rem;
        color: #95a5a6;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <input
        type="text"
        id="taskInput"
        placeholder="Was investierst du gerade?"
        onchange="checkTaskChange()"
      />
      <div class="timer" id="timerDisplay">00:00:00</div>
      <div class="btn-group" id="controls"></div>
    </div>

    <div class="card">
      <div class="stats-grid">
        <div class="stat-item">
          <span class="stat-label">Heute</span
          ><span class="stat-val" id="statDay">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Woche</span
          ><span class="stat-val" id="statWeek">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Monat</span
          ><span class="stat-val" id="statMonth">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label"
            >Jahr
            <select
              id="yearSelect"
              class="year-select"
              onchange="renderStats()"
            ></select
          ></span>
          <span class="stat-val" id="statYear">0</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="history-header">
        <div style="display: flex; align-items: center; gap: 10px">
          <strong>Verlauf</strong>
          <button class="btn-add-manual" onclick="toggleManualForm()">+</button>
        </div>
        <select
          id="historyFilter"
          onchange="renderHistory()"
          style="padding: 5px; border-radius: 5px; border: 1px solid #ccc"
        >
          <option value="0">Nur Heute</option>
          <option value="3" selected>Letzte 3 Tage</option>
          <option value="7">Letzte 7 Tage</option>
        </select>
      </div>

      <div id="manualForm">
        <div class="manual-header">
          <span>MANUELL HINZUFÜGEN</span>
          <button class="btn-close-x" onclick="toggleManualForm()">
            &times;
          </button>
        </div>
        <input type="text" id="manualTitle" placeholder="Titel der Aufgabe" />
        <input
          type="number"
          id="manualMins"
          placeholder="Minuten (z.B. 30)"
          pattern="\d*"
          inputmode="numeric"
        />
        <button class="btn-save-manual" onclick="saveManualTask()">
          Eintrag speichern
        </button>
      </div>

      <div id="historyList" class="history-list"></div>
    </div>

    <footer>
      &copy; <span id="copyrightYear"></span> Oliver Ahlig · Lebenszeit Tracker
    </footer>

    <script>
      document.getElementById("copyrightYear").innerText =
        new Date().getFullYear();

      let history = JSON.parse(localStorage.getItem("wt_history")) || [];
      let activeTask = JSON.parse(localStorage.getItem("wt_active")) || null;
      let archive = JSON.parse(localStorage.getItem("wt_archive")) || {
        days: {},
        weeks: {},
        months: {},
        years: {},
      };
      let timerInterval;

      // Zeitformatierung auf Deutsch: min -> Std -> Tg Std
      function formatTime(mins) {
        if (!mins || mins === 0) return "0 min";

        // Unter 90 Minuten -> min
        if (mins < 90) return mins + " min";

        // Ab 90 Minuten bis unter 24 Stunden -> Std (mit 1 Dezimalstelle)
        if (mins < 1440) {
          const hours = (mins / 60).toFixed(1);
          return hours.replace(".0", "") + " Std";
        }

        // Ab 24 Stunden -> Tage und Stunden
        const days = Math.floor(mins / 1440);
        const remainingMins = mins % 1440;
        const hours = Math.floor(remainingMins / 60);

        if (hours === 0) return `${days} Tg`;
        return `${days} Tg ${hours} Std`;
      }

      function getTimeKeys(dateStr) {
        const d = new Date(dateStr);
        const day = d.toISOString().split("T")[0];
        const month = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(
          2,
          "0"
        )}`;
        const year = `${d.getFullYear()}`;
        const t = new Date(d.getTime());
        t.setHours(0, 0, 0, 0);
        t.setDate(t.getDate() + 3 - ((t.getDay() + 6) % 7));
        const w1 = new Date(t.getFullYear(), 0, 4);
        const week = `${t.getFullYear()}-W${String(
          1 +
            Math.round(
              ((t.getTime() - w1.getTime()) / 86400000 -
                3 +
                ((w1.getDay() + 6) % 7)) /
                7
            )
        ).padStart(2, "0")}`;
        return { day, week, month, year };
      }

      function updateUI() {
        const ctrl = document.getElementById("controls");
        if (!activeTask) {
          ctrl.innerHTML = `<button class="btn-start" onclick="startTask()">Starten</button>`;
          document.getElementById("timerDisplay").innerText = "00:00:00";
        } else {
          const pLab = activeTask.isPaused ? "Weiter" : "Pause";
          ctrl.innerHTML = `<button class="btn-pause" onclick="togglePause()">${pLab}</button>
                            <button class="btn-stop" onclick="stopTask()">Stopp</button>`;
          document.getElementById("taskInput").value = activeTask.title;
        }
        renderStats();
        renderHistory();
      }

      function toggleManualForm() {
        const form = document.getElementById("manualForm");
        const isOpening = form.style.display !== "block";
        form.style.display = isOpening ? "block" : "none";
        if (isOpening) {
          document.getElementById("manualTitle").value =
            document.getElementById("taskInput").value;
          document.getElementById("manualMins").value = "";
          document.getElementById("manualTitle").focus();
        }
      }

      function saveManualTask() {
        const title =
          document.getElementById("manualTitle").value || "Manuelle Aufgabe";
        const mins = parseInt(document.getElementById("manualMins").value);
        if (!isNaN(mins) && mins > 0) {
          addToArchive(title, mins, new Date().toISOString());
          save();
          toggleManualForm();
          updateUI();
        }
      }

      function addToArchive(title, mins, dateIso) {
        const keys = getTimeKeys(dateIso);
        archive.days[keys.day] = (archive.days[keys.day] || 0) + mins;
        archive.weeks[keys.week] = (archive.weeks[keys.week] || 0) + mins;
        archive.months[keys.month] = (archive.months[keys.month] || 0) + mins;
        archive.years[keys.year] = (archive.years[keys.year] || 0) + mins;
        history.push({ title, duration: mins, date: dateIso });
        const limit = new Date();
        limit.setDate(limit.getDate() - 7);
        history = history.filter((item) => new Date(item.date) >= limit);
      }

      function startTask() {
        activeTask = {
          title: document.getElementById("taskInput").value || "Aufgabe",
          startTime: Date.now(),
          accumulatedTime: 0,
          isPaused: false,
          date: new Date().toISOString(),
        };
        save();
        runTimer();
        updateUI();
      }

      function togglePause() {
        if (activeTask.isPaused) {
          activeTask.startTime = Date.now();
          activeTask.isPaused = false;
        } else {
          activeTask.accumulatedTime += Date.now() - activeTask.startTime;
          activeTask.isPaused = true;
        }
        save();
        updateUI();
      }

      function stopTask() {
        if (!activeTask) return;
        let finalMs = activeTask.accumulatedTime;
        if (!activeTask.isPaused) finalMs += Date.now() - activeTask.startTime;
        let mins = Math.round(finalMs / 60000);
        if (mins > 0) addToArchive(activeTask.title, mins, activeTask.date);
        activeTask = null;
        clearInterval(timerInterval);
        save();
        updateUI();
      }

      function checkTaskChange() {
        if (
          activeTask &&
          document.getElementById("taskInput").value !== activeTask.title
        ) {
          stopTask();
          startTask();
        }
      }

      function deleteEntry(indexInFiltered) {
        const filterValue = parseInt(
          document.getElementById("historyFilter").value
        );
        const now = new Date();
        const todayStr = now.toDateString();
        const filtered = history
          .filter((item) => {
            const itemDate = new Date(item.date);
            if (filterValue === 0) return itemDate.toDateString() === todayStr;
            return (
              Math.ceil(Math.abs(now - itemDate) / 86400000) <= filterValue
            );
          })
          .slice()
          .reverse();
        const itemToDelete = filtered[indexInFiltered];
        if (new Date(itemToDelete.date).toDateString() !== todayStr)
          return alert("Nur heute löschbar.");
        if (confirm(`"${itemToDelete.title}" löschen?`)) {
          const k = getTimeKeys(itemToDelete.date);
          archive.days[k.day] -= itemToDelete.duration;
          archive.weeks[k.week] -= itemToDelete.duration;
          archive.months[k.month] -= itemToDelete.duration;
          archive.years[k.year] -= itemToDelete.duration;
          history = history.filter((i) => i !== itemToDelete);
          save();
          updateUI();
        }
      }

      function renderStats() {
        const k = getTimeKeys(new Date());
        const yearSelect = document.getElementById("yearSelect");
        const currentYear = new Date().getFullYear().toString();
        let years = Object.keys(archive.years || {});
        if (!years.includes(currentYear)) years.push(currentYear);
        years.sort((a, b) => b - a);
        if (yearSelect.options.length !== years.length) {
          const sel = yearSelect.value || currentYear;
          yearSelect.innerHTML = years
            .map(
              (y) =>
                `<option value="${y}" ${
                  y === sel ? "selected" : ""
                }>${y}</option>`
            )
            .join("");
        }
        const sYear = yearSelect.value || currentYear;

        document.getElementById("statDay").innerText = formatTime(
          archive.days[k.day]
        );
        document.getElementById("statWeek").innerText = formatTime(
          archive.weeks[k.week]
        );
        document.getElementById("statMonth").innerText = formatTime(
          archive.months[k.month]
        );
        document.getElementById("statYear").innerText = formatTime(
          archive.years[sYear]
        );
      }

      function renderHistory() {
        const filter = parseInt(document.getElementById("historyFilter").value);
        const now = new Date();
        const filtered = history.filter((item) => {
          const d = new Date(item.date);
          if (filter === 0) return d.toDateString() === now.toDateString();
          return Math.ceil(Math.abs(now - d) / 86400000) <= filter;
        });
        document.getElementById("historyList").innerHTML =
          filtered
            .slice()
            .reverse()
            .map(
              (item, index) => `
          <div class="history-item">
            <div class="task-info"><span class="task-title">${
              item.title
            }</span><span class="task-date">${new Date(
                item.date
              ).toLocaleTimeString("de-DE", {
                hour: "2-digit",
                minute: "2-digit",
              })} Uhr</span></div>
            <div style="display:flex; align-items:center; gap:12px;"><span class="task-dur">${formatTime(
              item.duration
            )}</span>
            ${
              new Date(item.date).toDateString() === now.toDateString()
                ? `<button onclick="deleteEntry(${index})" style="background:none; border:none; color:#e74c3c; font-size:1.4rem;">&times;</button>`
                : '<div style="width:25px;"></div>'
            }</div>
          </div>`
            )
            .join("") ||
          '<div style="text-align:center; padding:20px; color:#ccc;">Keine Einträge</div>';
      }

      function runTimer() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          if (!activeTask || activeTask.isPaused) return;
          const ms =
            activeTask.accumulatedTime + (Date.now() - activeTask.startTime);
          const h = Math.floor(ms / 3600000),
            m = Math.floor((ms % 3600000) / 60000),
            s = Math.floor((ms % 60000) / 1000);
          document.getElementById("timerDisplay").innerText = `${String(
            h
          ).padStart(2, "0")}:${String(m).padStart(2, "0")}:${String(
            s
          ).padStart(2, "0")}`;
        }, 1000);
      }

      function save() {
        localStorage.setItem("wt_active", JSON.stringify(activeTask));
        localStorage.setItem("wt_history", JSON.stringify(history));
        localStorage.setItem("wt_archive", JSON.stringify(archive));
      }

      if (activeTask && !activeTask.isPaused) runTimer();
      updateUI();
    </script>
  </body>
</html>
