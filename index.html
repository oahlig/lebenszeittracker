<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lebenszeit Tracker</title>
    <style>
      :root {
        --primary: #3498db;
        --secondary: #2ecc71;
        --warning: #f1c40f;
        --danger: #e74c3c;
        --bg: #f4f7f6;
      }
      body {
        font-family: -apple-system, sans-serif;
        background: var(--bg);
        padding: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0;
        min-height: 100vh; /* Sorgt dafür, dass das Impressum unten bleiben kann */
      }
      .card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        width: 100%;
        max-width: 400px;
        margin-bottom: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        box-sizing: border-box;
      }
      input {
        width: 100%;
        padding: 12px;
        margin-bottom: 10px;
        border: 2px solid #eee;
        border-radius: 8px;
        font-size: 1rem;
        box-sizing: border-box;
      }
      .timer {
        font-size: 3rem;
        text-align: center;
        margin: 10px 0;
        font-family: monospace;
        font-weight: bold;
        color: var(--primary);
      }
      .btn-group {
        display: flex;
        gap: 10px;
      }
      button {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        font-size: 1rem;
      }
      .btn-start {
        background: var(--secondary);
      }
      .btn-pause {
        background: var(--warning);
      }
      .btn-stop {
        background: var(--danger);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 10px;
      }
      .stat-item {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        border: 1px solid #eee;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .stat-label {
        font-size: 0.7rem;
        color: #7f8c8d;
        display: block;
        text-transform: uppercase;
        margin-bottom: 4px;
      }
      .stat-val {
        font-weight: bold;
        font-size: 1.1rem;
        color: #2c3e50;
      }

      .year-select {
        border: none;
        background: #ececec;
        font-size: 0.65rem;
        color: #555;
        border-radius: 4px;
        padding: 2px 4px;
        cursor: pointer;
        font-weight: bold;
      }

      .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .header-left {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .btn-add-manual {
        background: var(--primary);
        color: white;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
        border: none;
        line-height: 1;
      }

      .history-list {
        max-height: 250px;
        overflow-y: auto;
      }
      .history-item {
        padding: 10px;
        border-bottom: 1px solid #f1f1f1;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .history-item:last-child {
        border-bottom: none;
      }
      .task-info {
        display: flex;
        flex-direction: column;
      }
      .task-title {
        font-weight: bold;
        font-size: 0.9rem;
      }
      .task-date {
        font-size: 0.7rem;
        color: #bdc3c7;
      }
      .task-dur {
        font-weight: bold;
        color: var(--primary);
      }

      /* Impressum Style */
      footer {
        margin-top: auto;
        padding: 20px;
        text-align: center;
        font-size: 0.75rem;
        color: #95a5a6;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <input
        type="text"
        id="taskInput"
        placeholder="Was investierst du gerade?"
        onchange="checkTaskChange()"
      />
      <div class="timer" id="timerDisplay">00:00:00</div>
      <div class="btn-group" id="controls"></div>
    </div>

    <div class="card">
      <div class="stats-grid">
        <div class="stat-item">
          <span class="stat-label">Heute</span
          ><span class="stat-val" id="statDay">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Woche</span
          ><span class="stat-val" id="statWeek">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Monat</span
          ><span class="stat-val" id="statMonth">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">
            Jahr
            <select
              id="yearSelect"
              class="year-select"
              onchange="renderStats()"
            ></select>
          </span>
          <span class="stat-val" id="statYear">0</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="history-header">
        <div class="header-left">
          <strong>Verlauf</strong>
          <button
            class="btn-add-manual"
            onclick="addManualTask()"
            title="Manuell hinzufügen"
          >
            +
          </button>
        </div>
        <select
          id="historyFilter"
          onchange="renderHistory()"
          style="padding: 5px; border-radius: 5px; border: 1px solid #ccc"
        >
          <option value="0">Nur Heute</option>
          <option value="3" selected>Letzte 3 Tage</option>
          <option value="7">Letzte 7 Tage</option>
        </select>
      </div>
      <div id="historyList" class="history-list"></div>
    </div>

    <footer>
      &copy; <span id="copyrightYear"></span> Oliver Ahlig · Lebenszeit Tracker
    </footer>

    <script>
      document.getElementById("copyrightYear").innerText =
        new Date().getFullYear();

      let history = JSON.parse(localStorage.getItem("wt_history")) || [];
      let activeTask = JSON.parse(localStorage.getItem("wt_active")) || null;
      let archive = JSON.parse(localStorage.getItem("wt_archive")) || {
        days: {},
        weeks: {},
        months: {},
        years: {},
      };
      let timerInterval;

      function getTimeKeys(dateStr) {
        const d = new Date(dateStr);
        const day = d.toISOString().split("T")[0];
        const month = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(
          2,
          "0"
        )}`;
        const year = `${d.getFullYear()}`;
        const t = new Date(d.getTime());
        t.setHours(0, 0, 0, 0);
        t.setDate(t.getDate() + 3 - ((t.getDay() + 6) % 7));
        const w1 = new Date(t.getFullYear(), 0, 4);
        const week = `${t.getFullYear()}-W${String(
          1 +
            Math.round(
              ((t.getTime() - w1.getTime()) / 86400000 -
                3 +
                ((w1.getDay() + 6) % 7)) /
                7
            )
        ).padStart(2, "0")}`;
        return { day, week, month, year };
      }

      function updateUI() {
        const ctrl = document.getElementById("controls");
        if (!activeTask) {
          ctrl.innerHTML = `<button class="btn-start" onclick="startTask()">Starten</button>`;
          document.getElementById("timerDisplay").innerText = "00:00:00";
        } else {
          const pLab = activeTask.isPaused ? "Weiter" : "Pause";
          ctrl.innerHTML = `<button class="btn-pause" onclick="togglePause()">${pLab}</button>
                            <button class="btn-stop" onclick="stopTask()">Stopp</button>`;
          document.getElementById("taskInput").value = activeTask.title;
        }
        renderStats();
        renderHistory();
      }

      function startTask() {
        const title = document.getElementById("taskInput").value || "Aufgabe";
        activeTask = {
          title,
          startTime: Date.now(),
          accumulatedTime: 0,
          isPaused: false,
          date: new Date().toISOString(),
        };
        save();
        runTimer();
        updateUI();
      }

      function togglePause() {
        if (activeTask.isPaused) {
          activeTask.startTime = Date.now();
          activeTask.isPaused = false;
        } else {
          activeTask.accumulatedTime += Date.now() - activeTask.startTime;
          activeTask.isPaused = true;
        }
        save();
        updateUI();
      }

      function addManualTask() {
        const title = prompt(
          "Was hast du erledigt?",
          document.getElementById("taskInput").value || "Manuelle Aufgabe"
        );
        if (!title) return;
        const minsInput = prompt("Wie viele Minuten?", "15");
        const mins = parseInt(minsInput);
        if (!isNaN(mins) && mins > 0) {
          const now = new Date().toISOString();
          addToArchive(title, mins, now);
          save();
          updateUI();
        }
      }

      function addToArchive(title, mins, dateIso) {
        const keys = getTimeKeys(dateIso);
        archive.days[keys.day] = (archive.days[keys.day] || 0) + mins;
        archive.weeks[keys.week] = (archive.weeks[keys.week] || 0) + mins;
        archive.months[keys.month] = (archive.months[keys.month] || 0) + mins;
        archive.years[keys.year] = (archive.years[keys.year] || 0) + mins;
        history.push({ title, duration: mins, date: dateIso });
        const limit = new Date();
        limit.setDate(limit.getDate() - 7);
        history = history.filter((item) => new Date(item.date) >= limit);
      }

      function stopTask() {
        if (!activeTask) return;
        let finalMs = activeTask.accumulatedTime;
        if (!activeTask.isPaused) finalMs += Date.now() - activeTask.startTime;
        let mins = Math.round(finalMs / 60000);
        if (mins > 0) addToArchive(activeTask.title, mins, activeTask.date);
        activeTask = null;
        clearInterval(timerInterval);
        save();
        updateUI();
      }

      function checkTaskChange() {
        if (
          activeTask &&
          document.getElementById("taskInput").value !== activeTask.title
        ) {
          stopTask();
          startTask();
        }
      }

      function deleteEntry(indexInFiltered) {
        const filterValue = parseInt(
          document.getElementById("historyFilter").value
        );
        const now = new Date();
        const todayStr = now.toDateString();
        const filtered = history
          .filter((item) => {
            const itemDate = new Date(item.date);
            if (filterValue === 0) return itemDate.toDateString() === todayStr;
            const diffDays = Math.ceil(
              Math.abs(now - itemDate) / (1000 * 60 * 60 * 24)
            );
            return diffDays <= filterValue;
          })
          .slice()
          .reverse();
        const itemToDelete = filtered[indexInFiltered];
        if (new Date(itemToDelete.date).toDateString() !== todayStr) {
          alert("Nur heutige Einträge löschbar.");
          return;
        }
        if (confirm(`"${itemToDelete.title}" löschen?`)) {
          const keys = getTimeKeys(itemToDelete.date);
          if (archive.days[keys.day])
            archive.days[keys.day] -= itemToDelete.duration;
          if (archive.weeks[keys.week])
            archive.weeks[keys.week] -= itemToDelete.duration;
          if (archive.months[keys.month])
            archive.months[keys.month] -= itemToDelete.duration;
          if (archive.years[keys.year])
            archive.years[keys.year] -= itemToDelete.duration;
          history = history.filter((i) => i !== itemToDelete);
          save();
          updateUI();
        }
      }

      function renderStats() {
        const k = getTimeKeys(new Date());
        const yearSelect = document.getElementById("yearSelect");
        const currentYear = new Date().getFullYear().toString();
        let availableYears = Object.keys(archive.years);
        if (!availableYears.includes(currentYear))
          availableYears.push(currentYear);
        availableYears.sort((a, b) => b - a);
        if (yearSelect.options.length !== availableYears.length) {
          const currentSelection = yearSelect.value || currentYear;
          yearSelect.innerHTML = availableYears
            .map(
              (y) =>
                `<option value="${y}" ${
                  y === currentSelection ? "selected" : ""
                }>${y}</option>`
            )
            .join("");
        }
        const selectedYear = yearSelect.value || currentYear;
        document.getElementById("statDay").innerText =
          (archive.days[k.day] || 0) + "m";
        document.getElementById("statWeek").innerText =
          (archive.weeks[k.week] || 0) + "m";
        document.getElementById("statMonth").innerText =
          (archive.months[k.month] || 0) + "m";
        document.getElementById("statYear").innerText =
          (archive.years[selectedYear] || 0) + "m";
      }

      function renderHistory() {
        const filterValue = parseInt(
          document.getElementById("historyFilter").value
        );
        const list = document.getElementById("historyList");
        const now = new Date();
        const todayStr = now.toDateString();
        const filtered = history.filter((item) => {
          const itemDate = new Date(item.date);
          if (filterValue === 0) return itemDate.toDateString() === todayStr;
          const diffDays = Math.ceil(
            Math.abs(now - itemDate) / (1000 * 60 * 60 * 24)
          );
          return diffDays <= filterValue;
        });
        list.innerHTML =
          filtered
            .slice()
            .reverse()
            .map((item, index) => {
              const itemDate = new Date(item.date);
              const isToday = itemDate.toDateString() === todayStr;
              return `
                <div class="history-item">
                    <div class="task-info">
                        <span class="task-title">${item.title}</span>
                        <span class="task-date">${itemDate.toLocaleTimeString(
                          "de-DE",
                          { hour: "2-digit", minute: "2-digit" }
                        )} Uhr</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span class="task-dur">${item.duration}m</span>
                        ${
                          isToday
                            ? `<button onclick="deleteEntry(${index})" style="background: none; border: none; color: #e74c3c; font-size: 1.4rem; cursor: pointer;">&times;</button>`
                            : '<div style="width: 25px;"></div>'
                        } 
                    </div>
                </div>`;
            })
            .join("") ||
          '<div style="text-align:center; padding:20px; color:#ccc;">Keine Einträge</div>';
      }

      function runTimer() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          if (!activeTask || activeTask.isPaused) return;
          const ms =
            activeTask.accumulatedTime + (Date.now() - activeTask.startTime);
          const h = Math.floor(ms / 3600000),
            m = Math.floor((ms % 3600000) / 60000),
            s = Math.floor((ms % 60000) / 1000);
          document.getElementById("timerDisplay").innerText = `${String(
            h
          ).padStart(2, "0")}:${String(m).padStart(2, "0")}:${String(
            s
          ).padStart(2, "0")}`;
        }, 1000);
      }

      function save() {
        localStorage.setItem("wt_active", JSON.stringify(activeTask));
        localStorage.setItem("wt_history", JSON.stringify(history));
        localStorage.setItem("wt_archive", JSON.stringify(archive));
      }

      if (activeTask && !activeTask.isPaused) runTimer();
      updateUI();
    </script>
  </body>
</html>
